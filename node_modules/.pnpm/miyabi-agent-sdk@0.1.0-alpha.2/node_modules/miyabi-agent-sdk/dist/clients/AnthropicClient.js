/**
 * AnthropicClient - Claude Sonnet 4 API wrapper for Agent SDK
 *
 * Phase 8-1: Real API integration
 */
import Anthropic from "@anthropic-ai/sdk";
/**
 * AnthropicClient for Agent SDK
 *
 * Provides Claude Sonnet 4 API integration for:
 * - Issue analysis (IssueAgent)
 * - Code generation (CodeGenAgent)
 * - Code review (ReviewAgent)
 */
export class AnthropicClient {
    client;
    model = "claude-sonnet-4-20250514";
    constructor(apiKey) {
        const key = apiKey || process.env.ANTHROPIC_API_KEY;
        if (!key) {
            throw new Error("ANTHROPIC_API_KEY is required. Set it as environment variable or pass to constructor.");
        }
        this.client = new Anthropic({ apiKey: key });
    }
    /**
     * Analyze GitHub Issue with Claude Sonnet 4
     *
     * Used by IssueAgent for intelligent issue classification
     */
    async analyzeIssue(title, body) {
        const prompt = this.buildIssueAnalysisPrompt(title, body);
        const response = await this.client.messages.create({
            model: this.model,
            max_tokens: 1024,
            messages: [
                {
                    role: "user",
                    content: prompt,
                },
            ],
        });
        const content = response.content[0];
        if (content.type !== "text") {
            throw new Error("Unexpected response type from Claude API");
        }
        const result = this.parseJSON(content.text);
        console.log(`[AnthropicClient] Issue analyzed: ${result.type}, ${result.complexity}, ${result.priority}`);
        return {
            ...result,
            tokensUsed: {
                input: response.usage.input_tokens,
                output: response.usage.output_tokens,
            },
        };
    }
    /**
     * Generate code with Claude Sonnet 4
     *
     * Used by CodeGenAgent for high-quality code generation
     */
    async generateCode(requirements, context, language = "typescript") {
        const prompt = this.buildCodeGenPrompt(requirements, context, language);
        const response = await this.client.messages.create({
            model: this.model,
            max_tokens: 32768, // Increased to 32K (max: 64K) for complex code generation
            messages: [
                {
                    role: "user",
                    content: prompt,
                },
            ],
        });
        const content = response.content[0];
        if (content.type !== "text") {
            throw new Error("Unexpected response type from Claude API");
        }
        const result = this.parseJSON(content.text);
        console.log(`[AnthropicClient] Code generated: ${result.files.length} files, quality: ${result.qualityScore}`);
        return {
            ...result,
            tokensUsed: {
                input: response.usage.input_tokens,
                output: response.usage.output_tokens,
            },
        };
    }
    /**
     * Review code with Claude Sonnet 4
     *
     * Used by ReviewAgent for quality assessment
     */
    async reviewCode(files, standards) {
        const prompt = this.buildReviewPrompt(files, standards);
        const response = await this.client.messages.create({
            model: this.model,
            max_tokens: 4096,
            messages: [
                {
                    role: "user",
                    content: prompt,
                },
            ],
        });
        const content = response.content[0];
        if (content.type !== "text") {
            throw new Error("Unexpected response type from Claude API");
        }
        const result = this.parseJSON(content.text);
        console.log(`[AnthropicClient] Code reviewed: quality ${result.qualityScore}, ${result.passed ? "PASSED" : "FAILED"}`);
        return {
            ...result,
            tokensUsed: {
                input: response.usage.input_tokens,
                output: response.usage.output_tokens,
            },
        };
    }
    /**
     * Build prompt for issue analysis
     */
    buildIssueAnalysisPrompt(title, body) {
        return `ä»¥ä¸‹ã®GitHub Issueã‚’è§£æã—ã€é©åˆ‡ãªãƒ©ãƒ™ãƒ«ã€è¤‡é›‘åº¦ã€å„ªå…ˆåº¦ã€ç¨®é¡ã‚’åˆ¤å®šã—ã¦ãã ã•ã„ã€‚

# Issueæƒ…å ±
Title: ${title}
Body: ${body || "(æœ¬æ–‡ãªã—)"}

# ãƒ©ãƒ™ãƒ«ä½“ç³»ï¼ˆ116ãƒ©ãƒ™ãƒ«ã€15ã‚«ãƒ†ã‚´ãƒªï¼‰
- ğŸ·ï¸ type: bug, feature, refactor, docs, test, chore
- ğŸ¯ priority: P0-Critical, P1-High, P2-Medium, P3-Low
- ğŸ“Š complexity: small (<4h), medium (4-8h), large (1-3d), xlarge (>3d)
- ğŸ—ï¸ state: backlog, implementing, review, done
- ğŸ¤– agent: coordinator, issue, codegen, review, pr, test, deploy
- ğŸ”§ tech: rust, typescript, python, go
- ğŸŒ area: cli, tui, mcp, sdk, core
- ğŸ“¦ scope: api, ui, db, infra, security
- ğŸ¨ ux: a11y, i18n, perf, responsive
- ğŸ”¬ testing: unit, integration, e2e
- ğŸ“š docs: readme, guide, api-docs
- ğŸš€ release: major, minor, patch, alpha, beta
- ğŸ”’ security: vuln, cve, audit
- ğŸ’° cost: low, medium, high
- ğŸ“ˆ impact: breaking, enhancement, fix

# å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰
{
  "labels": ["ğŸ·ï¸ type:bug", "ğŸ¯ priority:P1-High", "ğŸ“Š complexity:medium", ...],
  "complexity": "small|medium|large|xlarge",
  "estimatedEffort": "1h|4h|1d|3d|1w|2w",
  "priority": "P0|P1|P2|P3",
  "type": "bug|feature|refactor|docs|test|chore",
  "reasoning": "åˆ¤å®šç†ç”±ã‚’ç°¡æ½”ã«èª¬æ˜"
}

**é‡è¦**: å¿…ãšJSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚JSONä»¥å¤–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚`;
    }
    /**
     * Build prompt for code generation
     */
    buildCodeGenPrompt(requirements, context, language) {
        return `ä»¥ä¸‹ã®è¦ä»¶ã«åŸºã¥ã„ã¦ã€${language}ã®ã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚

# è¦ä»¶
${requirements}

# ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ãƒ»é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
${context}

# å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰
{
  "files": [
    {
      "path": "src/example.ts",
      "content": "// ã‚³ãƒ¼ãƒ‰å†…å®¹ï¼ˆå®Œå…¨ãªã‚³ãƒ¼ãƒ‰ï¼‰",
      "action": "create|modify|delete"
    }
  ],
  "tests": [
    {
      "path": "src/example.test.ts",
      "content": "// ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ï¼ˆå®Œå…¨ãªãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ï¼‰",
      "action": "create|modify|delete"
    }
  ],
  "qualityScore": 85
}

# å“è³ªã‚¹ã‚³ã‚¢åŸºæº–
- 90-100: å„ªç§€ï¼ˆå‹å®‰å…¨ã€ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸90%ä»¥ä¸Šã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå®Œå‚™ï¼‰
- 80-89: è‰¯å¥½ï¼ˆå‹å®‰å…¨ã€ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Šï¼‰
- 70-79: å¯ï¼ˆä¸€éƒ¨å‹ã‚¨ãƒ©ãƒ¼ã€ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸70%ä»¥ä¸Šï¼‰
- 70æœªæº€: ä¸å¯

# ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
- TypeScript strict modeæº–æ‹ 
- ESLintæº–æ‹ ï¼ˆè­¦å‘Š0ä»¶ç›®æ¨™ï¼‰
- å®Œå…¨ãªå‹ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…
- ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰å¿…é ˆï¼ˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Šï¼‰
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚³ãƒ¡ãƒ³ãƒˆï¼ˆJSDocï¼‰

**é‡è¦**: å¿…ãšJSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚JSONä»¥å¤–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚`;
    }
    /**
     * Build prompt for code review
     */
    buildReviewPrompt(files, standards) {
        const filesContent = files
            .map((f) => `## ${f.path}\n\`\`\`\n${f.content}\n\`\`\``)
            .join("\n\n");
        return `ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

# ã‚³ãƒ¼ãƒ‰
${filesContent}

# å“è³ªåŸºæº–
- æœ€ä½å“è³ªã‚¹ã‚³ã‚¢: ${standards.minQualityScore}
- ãƒ†ã‚¹ãƒˆå¿…é ˆ: ${standards.requireTests ? "ã¯ã„" : "ã„ã„ãˆ"}
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³: ${standards.securityScan ? "ã¯ã„" : "ã„ã„ãˆ"}

# å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰
{
  "qualityScore": 85,
  "passed": true,
  "issues": [
    {
      "severity": "error|warning|info",
      "file": "src/example.ts",
      "line": 42,
      "message": "å•é¡Œã®è©³ç´°èª¬æ˜"
    }
  ],
  "suggestions": [
    "æ”¹å–„ææ¡ˆ1",
    "æ”¹å–„ææ¡ˆ2"
  ]
}

# ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
- å‹å®‰å…¨æ€§ï¼ˆTypeScript strict modeæº–æ‹ ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã€æ©Ÿå¯†æƒ…å ±æ¼æ´©ï¼‰
- ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸
- ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãƒ»ä¿å®ˆæ€§
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

**é‡è¦**: å¿…ãšJSONå½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ã€‚JSONä»¥å¤–ã®ãƒ†ã‚­ã‚¹ãƒˆã¯å«ã‚ãªã„ã§ãã ã•ã„ã€‚`;
    }
    /**
     * Parse JSON from Claude response
     *
     * Handles responses with or without ```json``` code blocks
     */
    parseJSON(text) {
        // Try multiple patterns to extract JSON
        // Pattern 1: ```json ... ``` (with or without newlines)
        let jsonMatch = text.match(/```json\s*([\s\S]*?)\s*```/);
        if (jsonMatch) {
            try {
                return JSON.parse(jsonMatch[1].trim());
            }
            catch {
                // Try next pattern
            }
        }
        // Pattern 2: ``` ... ``` (generic code block)
        jsonMatch = text.match(/```\s*([\s\S]*?)\s*```/);
        if (jsonMatch) {
            try {
                return JSON.parse(jsonMatch[1].trim());
            }
            catch {
                // Try next pattern
            }
        }
        // Pattern 3: Look for first { to last }
        jsonMatch = text.match(/(\{[\s\S]*\})/);
        if (jsonMatch) {
            try {
                return JSON.parse(jsonMatch[1].trim());
            }
            catch {
                // Try next pattern
            }
        }
        // Pattern 4: Try parsing the entire text as-is
        try {
            return JSON.parse(text.trim());
        }
        catch (error) {
            console.error("[AnthropicClient] Failed to parse JSON:", text.substring(0, 500));
            throw new Error(`Failed to parse Claude response as JSON: ${error instanceof Error ? error.message : "Unknown error"}`);
        }
    }
    /**
     * Calculate API cost (USD)
     *
     * Claude Sonnet 4 pricing (as of 2025-01):
     * - Input: $3 / 1M tokens
     * - Output: $15 / 1M tokens
     */
    calculateCost(tokensUsed) {
        const inputCost = (tokensUsed.input / 1_000_000) * 3.0;
        const outputCost = (tokensUsed.output / 1_000_000) * 15.0;
        return inputCost + outputCost;
    }
}
//# sourceMappingURL=AnthropicClient.js.map